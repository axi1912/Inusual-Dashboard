<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vouches - Inusual Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">`n    <link rel="stylesheet" href="/css/glassmorphism.css">`n    <link rel="stylesheet" href="/css/themes.css">`n    <link rel="stylesheet" href="/css/mobile.css">`n    <link rel="stylesheet" href="/css/charts.css">`n    <link rel="stylesheet" href="/css/visual-effects.css">
    <style>
        .filters-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            color: #00D9A3;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .filter-group input,
        .filter-group select {
            background: #0d0d0d;
            border: 1px solid #333;
            color: #fff;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #00D9A3;
        }

        .vouch-count {
            color: #888;
            font-size: 0.9rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <%- include('partials/navbar', { user: user, active: 'vouches' }) %>
    
    <div class="container">
        <div class="page-header">
            <h1>‚≠ê Vouches</h1>
            <p>User reviews and testimonials</p>
            <button class="btn-filter" onclick="exportVouchesToCSV()" style="float: right;">üì• Export to CSV</button>
        </div>

        <!-- Filtros -->
        <div class="filters-container">
            <div class="filters-row">
                <div class="filter-group">
                    <label for="searchVouch">üîç Search</label>
                    <input type="text" id="searchVouch" placeholder="Search by username...">
                </div>
                
                <div class="filter-group">
                    <label for="filterRating">‚≠ê Rating</label>
                    <select id="filterRating">
                        <option value="all">All Ratings</option>
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 stars)</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 stars)</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê (3 stars)</option>
                        <option value="2">‚≠ê‚≠ê (2 stars)</option>
                        <option value="1">‚≠ê (1 star)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterSort">üîÑ Sort By</label>
                    <select id="filterSort">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="rating-high">Highest Rating</option>
                        <option value="rating-low">Lowest Rating</option>
                    </select>
                </div>
            </div>
            <div class="vouch-count" id="vouchCount"></div>
        </div>

        <div class="vouches-grid" id="vouches-grid">
            <% if (vouches.length === 0) { %>
            <div style="text-align: center; padding: 4rem; color: #888; grid-column: 1/-1;">
                <p>No vouches yet</p>
            </div>
            <% } else { %>
            <% vouches.forEach(vouch => { %>
            <div class="vouch-card">
                <div class="vouch-header">
                    <div class="vouch-users">
                        <span class="from"><%= vouch.from %></span>
                        <span class="arrow">‚Üí</span>
                        <span class="to"><%= vouch.to %></span>
                    </div>
                    <div class="vouch-rating">
                        <% for(let i = 0; i < vouch.rating; i++) { %>‚≠ê<% } %>
                    </div>
                </div>
                <div class="vouch-review">
                    "<%= vouch.review %>"
                </div>
                <div class="vouch-date">
                    <%= vouch.date %>
                </div>
            </div>
            <% }); %>
            <% } %>
        </div>
    </div>

    <script>
        let allVouches = <%= JSON.stringify(vouches) %>;
        let filteredVouches = [...allVouches];

        // üöÄ SISTEMA INTELIGENTE DE ACTUALIZACIONES SIN REFRESH
        let updateTimer = null;
        
        function smartVouchesUpdate() {
            fetch('/api/vouches')
                .then(res => res.json())
                .then(data => {
                    const newCount = data.length;
                    const oldCount = allVouches.length;
                    
                    // Solo actualizar si hay cambios reales
                    if (newCount !== oldCount) {
                        console.log(`‚≠ê Vouches actualizados: ${oldCount} ‚Üí ${newCount}`);
                        allVouches = data;
                        applyFilters();
                        
                        // Notificaci√≥n visual si hay nuevos vouches
                        if (newCount > oldCount) {
                            showVouchNotification(`üåü ${newCount - oldCount} nuevo(s) vouch(es)!`);
                        }
                    }
                })
                .catch(err => {
                    console.error('Error updating vouches:', err);
                    showVouchNotification('‚ùå Error actualizando vouches', 'error');
                });
        }
        
        function showVouchNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `vouch-notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#ff6b6b' : '#f093fb'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function startSmartVouchUpdates() {
            // Actualizar cada 25 segundos
            updateTimer = setInterval(smartVouchesUpdate, 25000);
            console.log('‚úÖ Sistema inteligente de vouches iniciado');
        }
        
        function stopSmartVouchUpdates() {
            if (updateTimer) {
                clearInterval(updateTimer);
                updateTimer = null;
            }
        }
        
        // Pausar cuando la pesta√±a no est√° visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopSmartVouchUpdates();
            } else {
                startSmartVouchUpdates();
                smartVouchesUpdate();
            }
        });
        
        // Auto-refresh desactivado para mejor experiencia de usuario
        // Los datos se actualizan autom√°ticamente al realizar acciones
        // setInterval(() => {
        //     fetch('/api/vouches')
        //         .then(res => res.json())
        //         .then(data => {
        //             allVouches = data;
        //             applyFilters();
        //         })
        //         .catch(err => console.error('Error updating vouches:', err));
        // }, 5000);

        function applyFilters() {
            const searchTerm = document.getElementById('searchVouch').value.toLowerCase();
            const ratingFilter = document.getElementById('filterRating').value;
            const sortBy = document.getElementById('filterSort').value;

            // Filtrar
            filteredVouches = allVouches.filter(vouch => {
                const matchesSearch = !searchTerm || 
                    vouch.from.toLowerCase().includes(searchTerm) ||
                    vouch.to.toLowerCase().includes(searchTerm);
                
                const matchesRating = ratingFilter === 'all' || 
                    vouch.rating === parseInt(ratingFilter);
                
                return matchesSearch && matchesRating;
            });

            // Ordenar
            filteredVouches.sort((a, b) => {
                switch(sortBy) {
                    case 'newest':
                        return new Date(b.date) - new Date(a.date);
                    case 'oldest':
                        return new Date(a.date) - new Date(b.date);
                    case 'rating-high':
                        return b.rating - a.rating;
                    case 'rating-low':
                        return a.rating - b.rating;
                    default:
                        return 0;
                }
            });

            updateVouchesGrid(filteredVouches);
            updateVouchCount();
        }

        function updateVouchCount() {
            const count = filteredVouches.length;
            const total = allVouches.length;
            const avgRating = filteredVouches.length > 0 
                ? (filteredVouches.reduce((sum, v) => sum + v.rating, 0) / filteredVouches.length).toFixed(1)
                : 0;
            
            document.getElementById('vouchCount').textContent = 
                `Showing ${count} of ${total} vouch${total !== 1 ? 'es' : ''} | Average Rating: ${avgRating} ‚≠ê`;
        }

        function updateVouchesGrid(vouches) {
            const grid = document.getElementById('vouches-grid');
            
            if (vouches.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 4rem; color: #888; grid-column: 1/-1;"><p>No vouches yet</p></div>';
                return;
            }

            grid.innerHTML = vouches.map(vouch => `
                <div class="vouch-card">
                    <div class="vouch-header">
                        <div class="vouch-users">
                            <span class="from">${vouch.from}</span>
                            <span class="arrow">‚Üí</span>
                            <span class="to">${vouch.to}</span>
                        </div>
                        <div class="vouch-rating">
                            ${'‚≠ê'.repeat(vouch.rating)}
                        </div>
                    </div>
                    <div class="vouch-review">
                        "${vouch.review}"
                    </div>
                    <div class="vouch-date">
                        ${vouch.date}
                    </div>
                </div>
            `).join('');
        }

        // Event listeners para filtros en tiempo real
        document.getElementById('searchVouch').addEventListener('input', applyFilters);
        document.getElementById('filterRating').addEventListener('change', applyFilters);
        document.getElementById('filterSort').addEventListener('change', applyFilters);

        // Inicializar
        window.onload = () => {
            updateVouchCount();
            startSmartVouchUpdates(); // Iniciar actualizaciones inteligentes
        };

        // Exportar a CSV
        function exportVouchesToCSV() {
            const csv = [
                ['From', 'To', 'Rating', 'Review', 'Date'],
                ...filteredVouches.map(vouch => [
                    vouch.from,
                    vouch.to,
                    vouch.rating,
                    `"${vouch.review.replace(/"/g, '""')}"`,
                    vouch.date
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vouches_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
    <script src="/js/animations.js"></script>`n    <script src="/js/charts.js"></script>`n    <script src="/js/visual-effects.js"></script>`n</body>
</html>
