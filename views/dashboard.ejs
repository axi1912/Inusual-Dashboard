<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Inusual</title>
    <link rel="stylesheet" href="/css/style.css">`n    <link rel="stylesheet" href="/css/glassmorphism.css">`n    <link rel="stylesheet" href="/css/themes.css">`n    <link rel="stylesheet" href="/css/mobile.css">`n    <link rel="stylesheet" href="/css/charts.css">`n    <link rel="stylesheet" href="/css/charts-3d.css">`n    <link rel="stylesheet" href="/css/visual-effects.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <%- include('partials/navbar', { user: user, active: 'dashboard' }) %>
    
    <div class="container">
        <div class="page-header">
            <h1>ğŸ“Š Dashboard</h1>
            <p>Welcome back, <strong><%= user.username %></strong>!</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card hover-particles magnetic scroll-reveal">
                <div class="stat-icon">ğŸ«</div>
                <div class="stat-info">
                    <h3 id="total-tickets"><%= stats.totalTickets %></h3>
                    <p>Total Tickets</p>
                </div>
            </div>

            <div class="stat-card active">
                <div class="stat-icon">ğŸ“‚</div>
                <div class="stat-info">
                    <h3 id="active-tickets"><%= stats.activeTickets %></h3>
                    <p>Active Tickets</p>
                </div>
            </div>

            <div class="stat-card hover-particles magnetic scroll-reveal">
                <div class="stat-icon">â­</div>
                <div class="stat-info">
                    <h3 id="total-vouches"><%= stats.totalVouches %></h3>
                    <p>Total Vouches</p>
                </div>
            </div>

            <div class="stat-card hover-particles magnetic scroll-reveal">
                <div class="stat-icon">âœ…</div>
                <div class="stat-info">
                    <h3 id="verified-users"><%= stats.verifiedUsers %></h3>
                    <p>Verified Users</p>
                </div>
            </div>
        </div>

        <!-- 3D Charts Section -->
        <div class="charts-section">
            <h2>ğŸ¯ 3D Data Visualization</h2>
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>ğŸ“Š 3D Stats Cube</h3>
                    <div id="stats-3d-chart" class="chart-3d-container"></div>
                </div>
                <div class="chart-card">
                    <h3>ğŸŒ€ Activity Sphere</h3>
                    <div id="activity-3d-chart" class="chart-3d-container"></div>
                </div>
                <div class="chart-card">
                    <h3>ğŸ”¥ Performance Waves</h3>
                    <div id="performance-3d-chart" class="chart-3d-container"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="dashboard-content">
            <!-- Recent Tickets -->
            <div class="card">
                <h2>ğŸ« Recent Tickets</h2>
                <div id="recent-tickets-list" style="margin-top: 1rem;">
                    <p style="text-align: center; color: #888;">Loading tickets...</p>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card">
                <h2>ğŸ“ˆ Quick Stats</h2>
                <div class="quick-stats">
                    <div class="quick-stat">
                        <span class="label">Closed Tickets</span>
                        <span class="value"><%= stats.closedTickets %></span>
                    </div>
                    <div class="quick-stat">
                        <span class="label">Avg Response</span>
                        <span class="value">~5 min</span>
                    </div>
                    <div class="quick-stat">
                        <span class="label">Satisfaction</span>
                        <span class="value">98%</span>
                    </div>
                </div>
            </div>

            <!-- Bot Systems -->
            <div class="card">
                <h2>ğŸ¤– Bot Systems</h2>
                <div class="bot-list" id="bot-status-list">
                    <p style="text-align: center; color: #888; padding: 1rem;">Loading bot status...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cargar tickets recientes
        async function loadRecentTickets() {
            try {
                const response = await fetch('/api/tickets');
                const tickets = await response.json();
                displayRecentTickets(tickets.slice(0, 5));
            } catch (err) {
                console.error('Error loading tickets:', err);
                document.getElementById('recent-tickets-list').innerHTML = 
                    '<p style="text-align: center; color: #ff4444;">Error loading tickets</p>';
            }
        }

        function displayRecentTickets(tickets) {
            const container = document.getElementById('recent-tickets-list');
            
            if (!tickets || tickets.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">No tickets yet</p>';
                return;
            }

            container.innerHTML = tickets.map(ticket => {
                const statusColor = ticket.status === 'open' ? '#ffcc00' : '#00D9A3';
                const statusText = ticket.status === 'open' ? 'Open' : 'Closed';
                
                return `
                    <div style="padding: 1rem; margin-bottom: 0.75rem; background: #0d0d0d; border-left: 3px solid ${statusColor}; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: #fff; font-weight: 600;">Ticket #${ticket.id}</div>
                            <div style="color: #888; font-size: 0.9rem; margin-top: 0.25rem;">${ticket.user} - ${ticket.type}</div>
                        </div>
                        <div style="color: ${statusColor}; font-weight: 700; font-size: 0.9rem;">${statusText}</div>
                    </div>
                `;
            }).join('');
        }

        // Cargar estado de bots
        async function loadBotStatus() {
            try {
                const response = await fetch('/api/bots/status');
                const botsStatus = await response.json();
                displayBotStatus(botsStatus);
            } catch (err) {
                console.error('Error loading bot status:', err);
                displayBotStatus({});
            }
        }

        function displayBotStatus(botsStatus) {
            const container = document.getElementById('bot-status-list');
            const bots = [
                { id: 'inusual', name: 'Inusual Boosting', icon: 'ğŸ«' },
                { id: 'verification', name: 'Verification Bot', icon: 'âœ…' },
                { id: 'vouch', name: 'Vouch Bot', icon: 'â­' },
                { id: 'support', name: 'Support Bot', icon: 'ğŸ†˜' }
            ];

            container.innerHTML = bots.map(bot => {
                const status = botsStatus[bot.id] || { running: false };
                const isOnline = status.running;
                const statusColor = isOnline ? '#00D9A3' : '#ff4444';
                const statusText = isOnline ? 'Online' : 'Offline';
                
                return `
                    <div style="display: flex; align-items: center; padding: 0.75rem; background: #0d0d0d; border-left: 3px solid ${statusColor}; border-radius: 6px; margin-bottom: 0.5rem;">
                        <div style="font-size: 1.5rem; margin-right: 1rem;">${bot.icon}</div>
                        <div style="flex: 1; color: #fff; font-weight: 500;">${bot.name}</div>
                        <div style="color: ${statusColor}; font-weight: 700; font-size: 0.85rem;">${statusText}</div>
                    </div>
                `;
            }).join('');
        }

        // ğŸš€ REAL-TIME DATA UPDATES (Sin refrescar pÃ¡gina)
        function updateDashboardData() {
            // Actualizar estadÃ­sticas principales
            fetch('/api/stats')
                .then(res => res.json())
                .then(data => {
                    // Animar el cambio de nÃºmeros si es diferente
                    animateNumberUpdate('total-tickets', data.totalTickets);
                    animateNumberUpdate('active-tickets', data.activeTickets);
                    animateNumberUpdate('total-vouches', data.totalVouches);
                    animateNumberUpdate('verified-users', data.verifiedUsers);
                })
                .catch(err => console.error('Error updating stats:', err));

            // Actualizar tickets recientes (sin refrescar)
            loadRecentTickets();
            
            // Actualizar grÃ¡ficos en tiempo real si existen
            if (window.dashboardCharts) {
                window.dashboardCharts.updateRealtimeData();
            }
        }

        // FunciÃ³n para animar cambios de nÃºmeros
        function animateNumberUpdate(elementId, newValue) {
            const element = document.getElementById(elementId);
            const currentValue = parseInt(element.textContent) || 0;
            
            if (currentValue !== newValue) {
                element.style.transform = 'scale(1.1)';
                element.style.color = '#00D9A3';
                element.textContent = newValue;
                
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                    element.style.color = '';
                }, 300);
                
                // Crear efecto de partÃ­culas si aumentÃ³
                if (newValue > currentValue && window.visualEffects) {
                    const rect = element.getBoundingClientRect();
                    window.visualEffects.createExplosion(
                        rect.left + rect.width / 2, 
                        rect.top + rect.height / 2
                    );
                }
            }
        }

        // Actualizar cada 10 segundos (mÃ¡s suave)
        setInterval(updateDashboardData, 10000);        // Inicializar al cargar
        window.onload = () => {
            loadRecentTickets();
            loadBotStatus();
        };
    </script>
    <script src="/js/animations.js"></script>`n    <script src="/js/charts.js"></script>`n    <script src="/js/charts-3d.js"></script>`n    <script src="/js/visual-effects.js"></script>`n</body>
</html>
